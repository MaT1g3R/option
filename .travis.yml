language: python

matrix:
  include:
    - os: linux
      dist: bionic
      sudo: false
      python: '3.6'
      env: UPLOAD_COV=false
    - os: linux
      dist: bionic
      sudo: false
      python: '3.7'
      env: UPLOAD_COV=true

env: UPLOAD_COV=true
install:
  - make ci_install

script:
  - make lint
  - if [[ $UPLOAD_COV == "true" ]]; then
      make cov;
    else
      make test;
    fi

before_deploy:
  - make docs

deploy:
  - provider: script
    script: |
      if [[ $UPLOAD_COV == "true" ]]; then
        if [[ $(./check_publish.py) == "true" ]]; then
          poetry build;
          poetry publish -u $PYPI_USER -p $PYPI_PASS;
        fi
      fi
    on:
      branch: master
      condition: $UPLOAD_COV = true
  - provider: pages
    skip_cleanup: true
    github-token: $GITHUB_TOKEN
    keep-history: true
    local-dir: docs/_build/html
    on:
      branch: master
      condition: $UPLOAD_COV = true

notifications:
  email: false
